import*as e from"react";import t from"immer";import*as r from"jsonschema";import{setWith as n,unset as a,get as o,isEqual as i,cloneDeep as s}from"lodash-es";function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,h(e,t)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var v=e.createContext({value:void 0,schema:{},context:{},status:{}}),d=v.Consumer,y=function(r){function n(){for(var e,n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];return u(f(e=r.call.apply(r,[this].concat(a))||this),"state",{schema:{},value:{},extValue:{},status:{},context:{},oldProps:{}}),u(f(e),"dispatch",(function(r){for(var n=arguments.length,a=new Array(n>1?n-1:0),o=1;o<n;o++)a[o-1]=arguments[o];e.setState((function(e){return t(r).apply(void 0,[e].concat(a))}))})),e}l(n,r),n.getDerivedStateFromProps=function(e,t){if(t.oldProps!==e){var r={value:e.value,schema:e.schema,context:e.context,oldProps:e};return e.value!==t.extValue&&(r.status={},r.extValue=e.value),r}return null};var a=n.prototype;return a.shouldComponentUpdate=function(e,t){return this.state!==t},a.componentDidUpdate=function(e,t){var r=this;if(this.state.value!==t.value&&this.props.value===e.value){var n=this.state.value;this.setState({extValue:n},(function(){return r.props.onValueChange(n)}))}},a.render=function(){var t=this.state,r=t.schema,n=t.value,a=t.status,o=t.context,i=null!=n?JSON.parse(JSON.stringify(n)):n;return e.createElement(v.Provider,{value:{schema:r,value:i,context:o,status:a}},this.props.children({schema:r,value:i,status:a,context:o,dispatch:this.dispatch}))},n}(e.Component);var m={};function g(t){return m[t]||function(t){return function(){return e.createElement("span",null,"Widget for '"+t+"' was not defined")}}(t)}function b(e){m=Object.assign({},m,e)}var C={};function w(t){var r=t.value,n=t.schema,a=t.schema.view,o=t.__tree.value,i={value:r,schema:n,children:t.children,editKey:t.editKey,path:t.path,onChange:t.onChange,onChildAdd:t.onChildAdd,onChildRemove:t.onChildRemove,addKey:t.addKey,removeKey:t.removeKey,alterKey:t.alterKey,errorMessage:t.errorMessage,context:t.context};if(a){var s=a.type;if("string"==typeof s){var u=g(s);return e.createElement(u,c({},i,{formValue:o,view:a}))}if("function"==typeof s){var p=s;return e.createElement(p,c({},i,{formValue:o,view:a}))}}var l,h=Array.isArray(n.type)?n.type.find((function(e){return"null"!==e})):n.type;return l=g(void 0===h?"undefinedType":h),e.createElement(l,c({},i,{formValue:o,view:a||C}))}var E=new r.Validator;function O(e,t,r,n){return E.validate(e,t,{formValue:r||{},ctx:{basePath:n}})}E.attributes.errored=function(e,t,n,a){if("function"!=typeof t.errored)throw new r.SchemaError('"errored" expects a function');var o=(n.ctx.basePath||[]).concat(a.propertyPath.split(".").slice(1)),i=t.errored(e,n.formValue,o);if(i)return i};var j="value",P="status",x=[];function K(e,t,r){void 0===t&&(t=[]);var a=[P].concat(t).concat(["$$$errors"]);n(e,a,r,Object)}function A(e,t,r){void 0===t&&(t=[]);var n=new Map;r.forEach((function(e){var t=n.get(e.property)||[];t.push(e.message),n.set(e.property,t)})),K(e,t,x),n.forEach((function(r,n){K(e,t.concat(n.split(/\.|\[|\]/).filter((function(e){return""!==e})).slice(1)),r)}))}function k(e,t,r,a){void 0===t&&(t=[]);var o=[P].concat(t);n(e,[j].concat(t),r,Object),n(e,o.concat(["$$$state"]),"dirty",Object),A(e,t,a)}function S(e,t,r){void 0===t&&(t=[]),k(e,t,r,[]),n(e,[P].concat(t).concat(["$$$state"]),"pristine",Object)}function _(e,t){void 0===t&&(t=[]);try{a(e,[P].concat(t))}catch(e){}}function V(e,t){return void 0===t&&(t=[]),o(e,[P].concat(t).concat(["$$$errors"]))||x}function $(t){var r=function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return u(f(e=r.call.apply(r,[this].concat(n))||this),"onChange",(function(t){var r=O(t,e.props.schema,e.props.__tree.value,e.props.path);e.props.onChange(t,r.errors)})),e}l(n,r);var a=n.prototype;return a.shouldComponentUpdate=function(e){return this.props.value!==e.value||this.props.schema!==e.schema||V(this.props.__tree,this.props.path)!==V(e.__tree,e.path)},a.render=function(){var r=this.props.path;return e.createElement(t,c({},this.props,{errorMessage:V(this.props.__tree,r),onChange:this.onChange}))},n}(e.Component);return function(t){return e.createElement(d,null,(function(n){return e.createElement(r,c({},t,{__tree:n}))}))}}function D(e,t){return function(e,t){var r=e.properties,n=void 0===r?{}:r;if(t in n)return n[t]}(e,t)||function(e,t){var r=e.patternProperties||{},n=Object.keys(r).find((function(e){return new RegExp(e).test(t)}));if(n)return r[n]}(e,t)||e.additionalProperties}var N={},M=$(function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return u(f(e=t.call.apply(t,[this].concat(n))||this),"keys",new Map),u(f(e),"keyId",0),u(f(e),"addKey",(function(t,r){var n;if("object"==typeof e.props.value&&t in e.props.value)throw new Error('Property "'+t+'" already exists');e.keys.set(t,String(e.keyId++)),e.props.onChange(Object.assign({},e.props.value,((n={})[t]=r,n)))})),u(f(e),"removeKey",(function(t){var r=Object.assign({},e.props.value);delete r[t],e.keys.delete(t),e.props.onChange(r)})),u(f(e),"alterKey",(function(t,r){if(t!==r){if(r in e.props.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(e.props.value).forEach((function(a){a!==t?n[a]=e.props.value[a]:n[r]=e.props.value[a]}));var a=e.keys.get(t);e.keys.delete(t),e.keys.set(r,a),e.props.onChange(n)}})),e}l(r,t);var n=r.prototype;return n.renderChildren=function(t){var r=[],n=t.schema.properties||{},a=t.value||{},o=Object.keys(n);function i(e){if(n[e]){var t=n[e].index;if("number"==typeof t)return t}return 0}Object.keys(a).forEach((function(e){e in n||o.push(e)})),o.sort((function(e,t){return i(e)-i(t)}));for(var s=new Map,u=0;u<o.length;u+=1){var p=o[u],l=D(t.schema,p);this.keys.has(p)?s.set(p,this.keys.get(p)):s.set(p,String(this.keyId++)),r.push(e.createElement(Y,c({},t,{status:t.status[p]||N,schema:l,value:a[p],editKey:p,key:s.get(p)})))}return this.keys=s,r},n.render=function(){return e.createElement(w,c({},this.props,{addKey:this.addKey,removeKey:this.removeKey,alterKey:this.alterKey}),this.renderChildren(this.props))},r}(e.Component));function R(t){return e.createElement(w,t)}var U=$(R);function F(e){switch(typeof e){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var I=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return u(f(e=t.call.apply(t,[this].concat(n))||this),"state",{value:e.props.value}),u(f(e),"onChange",(function(t){var r=""===t?void 0:t,n=Number(r);e.setState({value:r},(function(){return e.props.onChange(isNaN(n)?r:n)}))})),e}return l(r,t),r.prototype.render=function(){return e.createElement(R,c({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(e.Component);u(I,"getDerivedStateFromProps",(function(e,t){return F(t.value)!==F(e.value)?{value:e.value}:null}));var J=$(I);var W=$((function(t){return e.createElement(w,t)})),T={};function q(e){return function(t){var r=e.value||[];e.onChange(r.filter((function(e,r){return Number(r)!==Number(t)})))}}function z(e){return function(t){var r=e.value||[];e.onChange(r.concat([t]))}}var B={object:M,string:U,number:J,boolean:W,array:$((function(t){return e.createElement(w,c({},t,{onChildAdd:z(t),onChildRemove:q(t)}),function(t){var r=t.value,n=t.schema.items,a=[];return(r||[]).forEach((function(r,o){return a.push(e.createElement(Y,c({},t,{schema:Array.isArray(n)?n[o]||{}:n,value:r,editKey:String(o),status:t.status[String(o)]||T,key:o})))})),a}(t))}))};function G(t){return e.createElement("div",null,'Undefined field type "'+t.schema.type.toString()+'", ['+t.path.toString()+"]")}function H(e){switch(typeof e){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function L(e){var t=e.value,r=e.schema.value,n=e.dispatch,a=e.path,o=void 0!==t?t:s(r);return o!==t&&n(S,a,o),o}var Q=function(t){function r(e){var r;return(r=t.call(this,e)||this).onChange=r.onChange.bind(f(r)),r}l(r,t);var n=r.prototype;return n.onChange=function(){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=this.props).dispatch.apply(e,[k,this.props.path].concat(r))},n.componentWillUnmount=function(){this.props.dispatch(_,this.props.path)},n.render=function(){var t,r=this.props.schema.type,n=Array.isArray(r)?r.find((function(e){return"null"!==e})):r;return void 0===(t=void 0===n||"null"===n?G:B[n])&&(t=G),e.createElement(t,c({},this.props,{onChange:this.onChange}))},r}(e.Component);u(Q,"defaultProps",{path:[]});var X,Y=function(t){return function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return u(f(e=r.call.apply(r,[this].concat(n))||this),"state",{path:[],schema:{}}),e}return l(n,r),n.getDerivedStateFromProps=function(e,t){var r,n,a={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(a.path=(r=e.path,void 0!==(n=e.editKey)?r.concat([n]):r),a.oldPath=e.path,a.oldEditKey=e.editKey),t.schema!==e.schema||H(e.value)!==H(t.oldValue)){var o=e.schema||{};"type"in o||(o=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){u(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({type:H(e.value)},o)),a.schema=o}return a},n.prototype.render=function(){var r=this.state.schema.type;return e.createElement(t,c({key:Array.isArray(r)?void 0:r},this.props,{path:this.state.path,schema:this.state.schema}))},n}(e.Component)}(function(t){return function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return u(f(e=r.call.apply(r,[this].concat(n))||this),"state",{val:L(e.props),init:!0}),e}return l(n,r),n.getDerivedStateFromProps=function(e,t){var r=e.schema,n=e.value,a=e.dispatch,o=e.path;if("const"in r&&!i(r.const,n)){var u=s(r.const);return a(S,o,u),{val:u}}return t.init?{init:!1}:{val:e.value}},n.prototype.render=function(){return e.createElement(t,c({},this.props,{value:this.state.val}))},n}(e.Component)}((X=Q,function(t){var r=t.schema.visible,n=t.value;return e.createElement(d,null,(function(a){var o=a.value;try{if(r&&!r(n,o,t.path.concat()))return null}catch(e){return null}return e.createElement(X,t)}))}))),Z=[],ee=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return u(f(e=t.call.apply(t,[this].concat(n))||this),"store",null),u(f(e),"update",(function(t){e.props.onChange(t,O(t,e.props.schema,t).errors)})),e}l(r,t);var n=r.prototype;return n.getValue=function(){return this.store.state.value},n.validate=function(){var e=O(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(A,[],e.errors),e.errors},n.render=function(){var t=this;return e.createElement(y,{ref:function(e){t.store=e},value:this.props.value,schema:this.props.schema,context:this.props.context,onValueChange:this.update},(function(t){var r=t.schema,n=t.value,a=t.status,o=t.dispatch,i=t.context;return e.createElement(Y,{schema:r,context:i,dispatch:o,value:n,path:Z,status:a})}))},r}(e.Component);u(ee,"defaultProps",{schema:{}});export default ee;export{b as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
