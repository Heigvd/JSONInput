import{createContext as t,createElement as e,Component as r}from"react";import n from"immer";import{Validator as a,SchemaError as o}from"jsonschema";import{setWith as i,unset as s,get as u,isEqual as c,cloneDeep as p}from"lodash-es";function h(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function l(){return(l=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function f(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function v(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,d(t,e)}function d(t,e){return(d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function y(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var m=t({value:void 0,schema:{},context:{},status:{}}),g=m.Consumer,b=function(t){function r(){for(var e,r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return h(y(e=t.call.apply(t,[this].concat(a))||this),"state",{schema:{},value:{},extValue:{},status:{},context:{},oldProps:{}}),h(y(e),"dispatch",(function(t){for(var r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];e.setState((function(e){return n(t).apply(void 0,[e].concat(a))}))})),e}v(r,t),r.getDerivedStateFromProps=function(t,e){if(e.oldProps!==t){var r={value:t.value,schema:t.schema,context:t.context,oldProps:t};return t.value!==e.extValue&&(r.status={},r.extValue=t.value),r}return null};var a=r.prototype;return a.shouldComponentUpdate=function(t,e){return this.state!==e},a.componentDidUpdate=function(t,e){var r=this;if(this.state.value!==e.value&&this.props.value===t.value){var n=this.state.value;this.setState({extValue:n},(function(){return r.props.onValueChange(n)}))}},a.render=function(){var t=this.state,r=t.schema,n=t.value,a=t.status,o=t.context,i=null!=n?JSON.parse(JSON.stringify(n)):n;return e(m.Provider,{value:{schema:r,value:i,context:o,status:a}},this.props.children({schema:r,value:i,status:a,context:o,dispatch:this.dispatch}))},r}(r);var w={};function O(t){return w[t]||function(t){return function(){return e("span",null,"Widget for '"+t+"' was not defined")}}(t)}function C(t){w=Object.assign({},w,t)}var j={};function P(t){var r=t.value,n=t.schema,a=t.schema.view,o=t.__tree.value,i={value:r,schema:n,children:t.children,editKey:t.editKey,path:t.path,onChange:t.onChange,onChildAdd:t.onChildAdd,onChildRemove:t.onChildRemove,addKey:t.addKey,removeKey:t.removeKey,alterKey:t.alterKey,errorMessage:t.errorMessage,context:t.context};if(a){var s=a.type;if("string"==typeof s){var u=O(s);return e(u,l({},i,{formValue:o,view:a}))}if("function"==typeof s)return e(s,l({},i,{formValue:o,view:a}))}var c,p=Array.isArray(n.type)?n.type.find((function(t){return"null"!==t})):n.type;return c=O(void 0===p?"undefinedType":p),e(c,l({},i,{formValue:o,view:a||j}))}var x=new a;function K(t,e,r,n){return x.validate(t,e,{formValue:r||{},ctx:{basePath:n}})}x.attributes.errored=function(t,e,r,n){if("function"!=typeof e.errored)throw new o('"errored" expects a function');var a=(r.ctx.basePath||[]).concat(n.propertyPath.split(".").slice(1)),i=e.errored(t,r.formValue,a);if(i)return i};var A="value",k="status",S=[];function _(t,e,r){void 0===e&&(e=[]);var n=[k].concat(e).concat(["$$$errors"]);i(t,n,r,Object)}function E(t,e,r){void 0===e&&(e=[]);var n=new Map;r.forEach((function(t){var e=n.get(t.property)||[];e.push(t.message),n.set(t.property,e)})),_(t,e,S),n.forEach((function(r,n){_(t,e.concat(n.split(/\.|\[|\]/).filter((function(t){return""!==t})).slice(1)),r)}))}function V(t,e,r,n){void 0===e&&(e=[]);var a=[k].concat(e);i(t,[A].concat(e),r,Object),i(t,a.concat(["$$$state"]),"dirty",Object),E(t,e,n)}function $(t,e,r){void 0===e&&(e=[]),V(t,e,r,[]),i(t,[k].concat(e).concat(["$$$state"]),"pristine",Object)}function D(t,e){void 0===e&&(e=[]);try{s(t,[k].concat(e))}catch(t){}}function N(t,e){return void 0===e&&(e=[]),u(t,[k].concat(e).concat(["$$$errors"]))||S}function M(t){var n=function(r){function n(){for(var t,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return h(y(t=r.call.apply(r,[this].concat(n))||this),"onChange",(function(e){var r=K(e,t.props.schema,t.props.__tree.value,t.props.path);t.props.onChange(e,r.errors)})),t}v(n,r);var a=n.prototype;return a.shouldComponentUpdate=function(t){return this.props.value!==t.value||this.props.schema!==t.schema||N(this.props.__tree,this.props.path)!==N(t.__tree,t.path)},a.render=function(){var r=this.props.path;return e(t,l({},this.props,{errorMessage:N(this.props.__tree,r),onChange:this.onChange}))},n}(r);return function(t){return e(g,null,(function(r){return e(n,l({},t,{__tree:r}))}))}}function R(t,e){return function(t,e){var r=t.properties,n=void 0===r?{}:r;if(e in n)return n[e]}(t,e)||function(t,e){var r=t.patternProperties||{},n=Object.keys(r).find((function(t){return new RegExp(t).test(e)}));if(n)return r[n]}(t,e)||t.additionalProperties}var U={},F=M(function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return h(y(e=t.call.apply(t,[this].concat(n))||this),"keys",new Map),h(y(e),"keyId",0),h(y(e),"addKey",(function(t,r){var n;if("object"==typeof e.props.value&&t in e.props.value)throw new Error('Property "'+t+'" already exists');e.keys.set(t,String(e.keyId++)),e.props.onChange(Object.assign({},e.props.value,((n={})[t]=r,n)))})),h(y(e),"removeKey",(function(t){var r=Object.assign({},e.props.value);delete r[t],e.keys.delete(t),e.props.onChange(r)})),h(y(e),"alterKey",(function(t,r){if(t!==r){if(r in e.props.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(e.props.value).forEach((function(a){a!==t?n[a]=e.props.value[a]:n[r]=e.props.value[a]}));var a=e.keys.get(t);e.keys.delete(t),e.keys.set(r,a),e.props.onChange(n)}})),e}v(r,t);var n=r.prototype;return n.renderChildren=function(t){var r=[],n=t.schema.properties||{},a=t.value||{},o=Object.keys(n);function i(t){if(n[t]){var e=n[t].index;if("number"==typeof e)return e}return 0}Object.keys(a).forEach((function(t){t in n||o.push(t)})),o.sort((function(t,e){return i(t)-i(e)}));for(var s=new Map,u=0;u<o.length;u+=1){var c=o[u],p=R(t.schema,c);this.keys.has(c)?s.set(c,this.keys.get(c)):s.set(c,String(this.keyId++)),r.push(e(et,l({},t,{status:t.status[c]||U,schema:p,value:a[c],editKey:c,key:s.get(c)})))}return this.keys=s,r},n.render=function(){return e(P,l({},this.props,{addKey:this.addKey,removeKey:this.removeKey,alterKey:this.alterKey}),this.renderChildren(this.props))},r}(r));function I(t){return e(P,t)}var J=M(I);function W(t){switch(typeof t){case"number":return t;case"string":return""===t?void 0:Number(t);default:return}}var T=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return h(y(e=t.call.apply(t,[this].concat(n))||this),"state",{value:e.props.value}),h(y(e),"onChange",(function(t){var r=""===t?void 0:t,n=Number(r);e.setState({value:r},(function(){return e.props.onChange(isNaN(n)?r:n)}))})),e}return v(r,t),r.prototype.render=function(){return e(I,l({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(r);h(T,"getDerivedStateFromProps",(function(t,e){return W(e.value)!==W(t.value)?{value:t.value}:null}));var q=M(T);var z=M((function(t){return e(P,t)})),B={};function G(t){return function(e){var r=t.value||[];t.onChange(r.filter((function(t,r){return Number(r)!==Number(e)})))}}function H(t){return function(e){var r=t.value||[];t.onChange(r.concat([e]))}}var L={object:F,string:J,number:q,boolean:z,array:M((function(t){return e(P,l({},t,{onChildAdd:H(t),onChildRemove:G(t)}),function(t){var r=t.value,n=t.schema.items,a=[];return(r||[]).forEach((function(r,o){return a.push(e(et,l({},t,{schema:Array.isArray(n)?n[o]||{}:n,value:r,editKey:String(o),status:t.status[String(o)]||B,key:o})))})),a}(t))}))};function Q(t){return e("div",null,'Undefined field type "'+t.schema.type.toString()+'", ['+t.path.toString()+"]")}function X(t){switch(typeof t){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(t)?"array":"object";default:return"string"}}function Y(t){var e=t.value,r=t.schema.value,n=t.dispatch,a=t.path,o=void 0!==e?e:p(r);return o!==e&&n($,a,o),o}var Z=function(t){function r(e){var r;return(r=t.call(this,e)||this).onChange=r.onChange.bind(y(r)),r}v(r,t);var n=r.prototype;return n.onChange=function(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=this.props).dispatch.apply(t,[V,this.props.path].concat(r))},n.componentWillUnmount=function(){this.props.dispatch(D,this.props.path)},n.render=function(){var t,r=this.props.schema.type,n=Array.isArray(r)?r.find((function(t){return"null"!==t})):r;return void 0===(t=void 0===n||"null"===n?Q:L[n])&&(t=Q),e(t,l({},this.props,{onChange:this.onChange}))},r}(r);h(Z,"defaultProps",{path:[]});var tt,et=function(t){return function(r){function n(){for(var t,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return h(y(t=r.call.apply(r,[this].concat(n))||this),"state",{path:[],schema:{}}),t}return v(n,r),n.getDerivedStateFromProps=function(t,e){var r,n,a={};if(e.oldEditKey===t.editKey&&e.oldPath===t.path||(a.path=(r=t.path,void 0!==(n=t.editKey)?r.concat([n]):r),a.oldPath=t.path,a.oldEditKey=t.editKey),e.schema!==t.schema||X(t.value)!==X(e.oldValue)){var o=t.schema||{};"type"in o||(o=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?f(Object(r),!0).forEach((function(e){h(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}({type:X(t.value)},o)),a.schema=o}return a},n.prototype.render=function(){var r=this.state.schema.type;return e(t,l({key:Array.isArray(r)?void 0:r},this.props,{path:this.state.path,schema:this.state.schema}))},n}(r)}(function(t){return function(r){function n(){for(var t,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return h(y(t=r.call.apply(r,[this].concat(n))||this),"state",{val:Y(t.props),init:!0}),t}return v(n,r),n.getDerivedStateFromProps=function(t,e){var r=t.schema,n=t.value,a=t.dispatch,o=t.path;if("const"in r&&!c(r.const,n)){var i=p(r.const);return a($,o,i),{val:i}}return e.init?{init:!1}:{val:t.value}},n.prototype.render=function(){return e(t,l({},this.props,{value:this.state.val}))},n}(r)}((tt=Z,function(t){var r=t.schema.visible,n=t.value;return e(g,null,(function(a){var o=a.value;try{if(r&&!r(n,o,t.path.concat()))return null}catch(t){return null}return e(tt,t)}))}))),rt=[],nt=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return h(y(e=t.call.apply(t,[this].concat(n))||this),"store",null),h(y(e),"update",(function(t){e.props.onChange(t,K(t,e.props.schema,t).errors)})),e}v(r,t);var n=r.prototype;return n.getValue=function(){return this.store.state.value},n.validate=function(){var t=K(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(E,[],t.errors),t.errors},n.render=function(){var t=this;return e(b,{ref:function(e){t.store=e},value:this.props.value,schema:this.props.schema,context:this.props.context,onValueChange:this.update},(function(t){var r=t.schema,n=t.value,a=t.status,o=t.dispatch,i=t.context;return e(et,{schema:r,context:i,dispatch:o,value:n,path:rt,status:a})}))},r}(r);h(nt,"defaultProps",{schema:{}});export default nt;export{C as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
