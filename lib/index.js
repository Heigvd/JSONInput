"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("immer"),r=require("jsonschema"),n=require("lodash-es");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var i=o(e),u=a(t),s=o(r);function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(){return(p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function h(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,f(e,t)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var d=i.createContext({value:void 0,schema:{},context:{},status:{}}),y=d.Consumer,m=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(t=e.call.apply(e,[this].concat(n))||this),"state",{schema:{},value:{},extValue:{},status:{},context:{},oldProps:{}}),c(v(t),"dispatch",(function(e){for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];t.setState((function(t){return u.default(e).apply(void 0,[t].concat(n))}))})),t}h(t,e),t.getDerivedStateFromProps=function(e,t){if(t.oldProps!==e){var r={value:e.value,schema:e.schema,context:e.context,oldProps:e};return e.value!==t.extValue&&(r.status={},r.extValue=e.value),r}return null};var r=t.prototype;return r.shouldComponentUpdate=function(e,t){return this.state!==t},r.componentDidUpdate=function(e,t){var r=this;if(this.state.value!==t.value&&this.props.value===e.value){var n=this.state.value;this.setState({extValue:n},(function(){return r.props.onValueChange(n)}))}},r.render=function(){var e=this.state,t=e.schema,r=e.value,n=e.status,a=e.context,o=null!=r?JSON.parse(JSON.stringify(r)):r;return i.createElement(d.Provider,{value:{schema:t,value:o,context:a,status:n}},this.props.children({schema:t,value:o,status:n,context:a,dispatch:this.dispatch}))},t}(i.Component);var g={};function b(e){return g[e]||function(e){return function(){return i.createElement("span",null,"Widget for '"+e+"' was not defined")}}(e)}var O={};function C(e){var t=e.value,r=e.schema,n=e.schema.view,a=e.__tree.value,o={value:t,schema:r,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage,context:e.context};if(n){var u=n.type;if("string"==typeof u){var s=b(u);return i.createElement(s,p({},o,{formValue:a,view:n}))}if("function"==typeof u){var c=u;return i.createElement(c,p({},o,{formValue:a,view:n}))}}var l,h=Array.isArray(r.type)?r.type.find((function(e){return"null"!==e})):r.type;return l=b(void 0===h?"undefinedType":h),i.createElement(l,p({},o,{formValue:a,view:n||O}))}var j=new s.Validator;function E(e,t,r,n){return j.validate(e,t,{formValue:r||{},ctx:{basePath:n}})}j.attributes.errored=function(e,t,r,n){if("function"!=typeof t.errored)throw new s.SchemaError('"errored" expects a function');var a=(r.ctx.basePath||[]).concat(n.propertyPath.split(".").slice(1)),o=t.errored(e,r.formValue,a);if(o)return o};var w="value",P="status",x=[];function K(e,t,r){void 0===t&&(t=[]);var a=[P].concat(t).concat(["$$$errors"]);n.setWith(e,a,r,Object)}function A(e,t,r){void 0===t&&(t=[]);var n=new Map;r.forEach((function(e){var t=n.get(e.property)||[];t.push(e.message),n.set(e.property,t)})),K(e,t,x),n.forEach((function(r,n){K(e,t.concat(n.split(/\.|\[|\]/).filter((function(e){return""!==e})).slice(1)),r)}))}function k(e,t,r,a){void 0===t&&(t=[]);var o=[P].concat(t);n.setWith(e,[w].concat(t),r,Object),n.setWith(e,o.concat(["$$$state"]),"dirty",Object),A(e,t,a)}function _(e,t,r){void 0===t&&(t=[]),k(e,t,r,[]),n.setWith(e,[P].concat(t).concat(["$$$state"]),"pristine",Object)}function S(e,t){void 0===t&&(t=[]);try{n.unset(e,[P].concat(t))}catch(e){}}function V(e,t){return void 0===t&&(t=[]),n.get(e,[P].concat(t).concat(["$$$errors"]))||x}function D(e){var t=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(e=t.call.apply(t,[this].concat(n))||this),"onChange",(function(t){var r=E(t,e.props.schema,e.props.__tree.value,e.props.path);e.props.onChange(t,r.errors)})),e}h(r,t);var n=r.prototype;return n.shouldComponentUpdate=function(e){return this.props.value!==e.value||this.props.schema!==e.schema||V(this.props.__tree,this.props.path)!==V(e.__tree,e.path)},n.render=function(){var t=this.props.path;return i.createElement(e,p({},this.props,{errorMessage:V(this.props.__tree,t),onChange:this.onChange}))},r}(i.Component);return function(e){return i.createElement(y,null,(function(r){return i.createElement(t,p({},e,{__tree:r}))}))}}function $(e,t){return function(e,t){var r=e.properties,n=void 0===r?{}:r;if(t in n)return n[t]}(e,t)||function(e,t){var r=e.patternProperties||{},n=Object.keys(r).find((function(e){return new RegExp(e).test(t)}));if(n)return r[n]}(e,t)||e.additionalProperties}var M={},N=D(function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(t=e.call.apply(e,[this].concat(n))||this),"keys",new Map),c(v(t),"keyId",0),c(v(t),"addKey",(function(e,r){var n;if("object"==typeof t.props.value&&e in t.props.value)throw new Error('Property "'+e+'" already exists');t.keys.set(e,String(t.keyId++)),t.props.onChange(Object.assign({},t.props.value,((n={})[e]=r,n)))})),c(v(t),"removeKey",(function(e){var r=Object.assign({},t.props.value);delete r[e],t.keys.delete(e),t.props.onChange(r)})),c(v(t),"alterKey",(function(e,r){if(e!==r){if(r in t.props.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(t.props.value).forEach((function(a){a!==e?n[a]=t.props.value[a]:n[r]=t.props.value[a]}));var a=t.keys.get(e);t.keys.delete(e),t.keys.set(r,a),t.props.onChange(n)}})),t}h(t,e);var r=t.prototype;return r.renderChildren=function(e){var t=[],r=e.schema.properties||{},n=e.value||{},a=Object.keys(r);function o(e){if(r[e]){var t=r[e].index;if("number"==typeof t)return t}return 0}Object.keys(n).forEach((function(e){e in r||a.push(e)})),a.sort((function(e,t){return o(e)-o(t)}));for(var u=new Map,s=0;s<a.length;s+=1){var c=a[s],l=$(e.schema,c);this.keys.has(c)?u.set(c,this.keys.get(c)):u.set(c,String(this.keyId++)),t.push(i.createElement(Y,p({},e,{status:e.status[c]||M,schema:l,value:n[c],editKey:c,key:u.get(c)})))}return this.keys=u,t},r.render=function(){return i.createElement(C,p({},this.props,{addKey:this.addKey,removeKey:this.removeKey,alterKey:this.alterKey}),this.renderChildren(this.props))},t}(i.Component));function W(e){return i.createElement(C,e)}var q=D(W);function R(e){switch(typeof e){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var U=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(t=e.call.apply(e,[this].concat(n))||this),"state",{value:t.props.value}),c(v(t),"onChange",(function(e){var r=""===e?void 0:e,n=Number(r);t.setState({value:r},(function(){return t.props.onChange(isNaN(n)?r:n)}))})),t}return h(t,e),t.prototype.render=function(){return i.createElement(W,p({},this.props,{value:this.state.value,onChange:this.onChange}))},t}(i.Component);c(U,"getDerivedStateFromProps",(function(e,t){return R(t.value)!==R(e.value)?{value:e.value}:null}));var F=D(U);var I=D((function(e){return i.createElement(C,e)})),J={};function z(e){return function(t){var r=e.value||[];e.onChange(r.filter((function(e,r){return Number(r)!==Number(t)})))}}function T(e){return function(t){var r=e.value||[];e.onChange(r.concat([t]))}}var B={object:N,string:q,number:F,boolean:I,array:D((function(e){return i.createElement(C,p({},e,{onChildAdd:T(e),onChildRemove:z(e)}),function(e){var t=e.value,r=e.schema.items,n=[];return(t||[]).forEach((function(t,a){return n.push(i.createElement(Y,p({},e,{schema:Array.isArray(r)?r[a]||{}:r,value:t,editKey:String(a),status:e.status[String(a)]||J,key:a})))})),n}(e))}))};function G(e){return i.createElement("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function H(e){switch(typeof e){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function L(e){var t=e.value,r=e.schema.value,a=e.dispatch,o=e.path,i=void 0!==t?t:n.cloneDeep(r);return i!==t&&a(_,o,i),i}var Q=function(e){function t(t){var r;return(r=e.call(this,t)||this).onChange=r.onChange.bind(v(r)),r}h(t,e);var r=t.prototype;return r.onChange=function(){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=this.props).dispatch.apply(e,[k,this.props.path].concat(r))},r.componentWillUnmount=function(){this.props.dispatch(S,this.props.path)},r.render=function(){var e,t=this.props.schema.type,r=Array.isArray(t)?t.find((function(e){return"null"!==e})):t;return void 0===(e=void 0===r||"null"===r?G:B[r])&&(e=G),i.createElement(e,p({},this.props,{onChange:this.onChange}))},t}(i.Component);c(Q,"defaultProps",{path:[]});var X,Y=function(e){return function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(e=t.call.apply(t,[this].concat(n))||this),"state",{path:[],schema:{}}),e}return h(r,t),r.getDerivedStateFromProps=function(e,t){var r,n,a={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(a.path=(r=e.path,void 0!==(n=e.editKey)?r.concat([n]):r),a.oldPath=e.path,a.oldEditKey=e.editKey),t.schema!==e.schema||H(e.value)!==H(t.oldValue)){var o=e.schema||{};"type"in o||(o=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){c(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({type:H(e.value)},o)),a.schema=o}return a},r.prototype.render=function(){var t=this.state.schema.type;return i.createElement(e,p({key:Array.isArray(t)?void 0:t},this.props,{path:this.state.path,schema:this.state.schema}))},r}(i.Component)}(function(e){return function(t){function r(){for(var e,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(e=t.call.apply(t,[this].concat(n))||this),"state",{val:L(e.props),init:!0}),e}return h(r,t),r.getDerivedStateFromProps=function(e,t){var r=e.schema,a=e.value,o=e.dispatch,i=e.path;if("const"in r&&!n.isEqual(r.const,a)){var u=n.cloneDeep(r.const);return o(_,i,u),{val:u}}return t.init?{init:!1}:{val:e.value}},r.prototype.render=function(){return i.createElement(e,p({},this.props,{value:this.state.val}))},r}(i.Component)}((X=Q,function(e){var t=e.schema.visible,r=e.value;return i.createElement(y,null,(function(n){var a=n.value;try{if(t&&!t(r,a,e.path.concat()))return null}catch(e){return null}return i.createElement(X,e)}))}))),Z=[],ee=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return c(v(t=e.call.apply(e,[this].concat(n))||this),"store",null),c(v(t),"update",(function(e){t.props.onChange(e,E(e,t.props.schema,e).errors)})),t}h(t,e);var r=t.prototype;return r.getValue=function(){return this.store.state.value},r.validate=function(){var e=E(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(A,[],e.errors),e.errors},r.render=function(){var e=this;return i.createElement(m,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,context:this.props.context,onValueChange:this.update},(function(e){var t=e.schema,r=e.value,n=e.status,a=e.dispatch,o=e.context;return i.createElement(Y,{schema:t,context:o,dispatch:a,value:r,path:Z,status:n})}))},t}(i.Component);c(ee,"defaultProps",{schema:{}}),exports.default=ee,exports.setDefaultWidgets=function(e){g=Object.assign({},g,e)};
//# sourceMappingURL=index.js.map
